<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prontuário - [[${paciente.nome}]] | CCA</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .prontuario-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .card-prontuario {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 1.5rem;
        }
        
        .card-header-custom {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
        }
        
        .imagem-thumb {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .imagem-thumb:hover {
            transform: scale(1.05);
        }
        
        .status-badge {
            font-size: 0.875rem;
        }
        
        .tratamento-item {
            border-left: 4px solid #007bff;
            padding-left: 1rem;
        }
        
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        
        .upload-area.dragover {
            border-color: #28a745;
            background-color: #d4edda;
        }
        
        .stats-card {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav th:replace="fragments/layout :: navbar('prontuarios')"></nav>

    <!-- Header do Prontuário -->
    <div class="prontuario-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="bi bi-clipboard-heart me-2"></i>
                        Prontuário Odontológico
                    </h1>
                    <h3 class="mb-0" th:text="${paciente.nome}">Nome do Paciente</h3>
                    <p class="mb-0 mt-1">
                        <span th:if="${paciente.email}" th:text="${paciente.email}">email@exemplo.com</span>
                        <span th:if="${paciente.telefone}" class="ms-3">
                            <i class="bi bi-whatsapp"></i> 
                            <span th:text="${paciente.telefone}">(11) 99999-9999</span>
                        </span>
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="stats-card p-3 rounded text-dark">
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="mb-0" th:text="${estatisticas.totalImagens}">0</h4>
                                <small>Imagens</small>
                            </div>
                            <div class="col-6">
                                <h4 class="mb-0" th:text="${estatisticas.totalTratamentos}">0</h4>
                                <small>Tratamentos</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Alertas -->
        <div th:if="${sucesso}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>
            <span th:text="${sucesso}">Mensagem de sucesso</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <div th:if="${erro}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span th:text="${erro}">Mensagem de erro</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Abas do Prontuário -->
        <ul class="nav nav-tabs mb-4" id="prontuarioTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-pane" type="button" role="tab">
                    <i class="bi bi-info-circle me-2"></i>Informações Gerais
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="imagens-tab" data-bs-toggle="tab" data-bs-target="#imagens-pane" type="button" role="tab">
                    <i class="bi bi-camera me-2"></i>Imagens Radiológicas
                    <span class="badge bg-primary ms-1" th:text="${#lists.size(imagens)}">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tratamentos-tab" data-bs-toggle="tab" data-bs-target="#tratamentos-pane" type="button" role="tab">
                    <i class="bi bi-clipboard-data me-2"></i>Tratamentos
                    <span class="badge bg-success ms-1" th:text="${#lists.size(tratamentos)}">0</span>
                </button>
            </li>
        </ul>

        <div class="tab-content" id="prontuarioTabContent">
            <!-- Aba: Informações Gerais -->
            <div class="tab-pane fade show active" id="info-pane" role="tabpanel">
                <form th:action="@{/prontuarios/{id}/atualizar(id=${prontuario.id})}" method="post">
                    <div class="card card-prontuario">
                        <div class="card-header card-header-custom">
                            <h5 class="mb-0">
                                <i class="bi bi-person-lines-fill me-2"></i>
                                Informações do Prontuário
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Histórico Médico</label>
                                        <textarea class="form-control" name="historicoMedico" rows="4" 
                                                placeholder="Histórico médico do paciente..."
                                                th:text="${prontuario.historicoMedico}"></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Medicamentos em Uso</label>
                                        <textarea class="form-control" name="medicamentosUso" rows="3"
                                                placeholder="Medicamentos que o paciente está usando..."
                                                th:text="${prontuario.medicamentosUso}"></textarea>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Alergias</label>
                                        <textarea class="form-control" name="alergias" rows="4"
                                                placeholder="Alergias conhecidas do paciente..."
                                                th:text="${prontuario.alergias}"></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Observações Gerais</label>
                                        <textarea class="form-control" name="observacoesGerais" rows="3"
                                                placeholder="Observações gerais sobre o paciente..."
                                                th:text="${prontuario.observacoesGerais}"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-floppy me-2"></i>Salvar Alterações
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Aba: Imagens Radiológicas -->
            <div class="tab-pane fade" id="imagens-pane" role="tabpanel">
                <!-- Upload de Imagens -->
                <div class="card card-prontuario">
                    <div class="card-header card-header-custom">
                        <h5 class="mb-0">
                            <i class="bi bi-cloud-upload me-2"></i>
                            Adicionar Nova Imagem
                        </h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/prontuarios/{id}/imagem/upload(id=${prontuario.id})}" 
                              method="post" enctype="multipart/form-data" id="uploadForm">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Tipo de Imagem</label>
                                        <select class="form-select" name="tipoImagem" required>
                                            <option value="">Selecione o tipo</option>
                                            <option th:each="tipo : ${tiposImagem}" 
                                                    th:value="${tipo}" th:text="${tipo}"></option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label class="form-label">Descrição</label>
                                        <input type="text" class="form-control" name="descricao" 
                                               placeholder="Descrição da imagem (opcional)">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Área de Upload -->
                            <div class="upload-area" id="uploadArea">
                                <input type="file" id="arquivo" name="arquivo" accept="image/*" 
                                       style="display: none;" required>
                                <i class="bi bi-cloud-upload fs-1 text-muted mb-2"></i>
                                <p class="mb-2">Clique aqui ou arraste uma imagem</p>
                                <small class="text-muted">Formatos suportados: JPG, PNG, JPEG (máx. 10MB)</small>
                            </div>
                            
                            <div class="text-end mt-3">
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-upload me-2"></i>Fazer Upload
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Lista de Imagens -->
                <div class="card card-prontuario">
                    <div class="card-header card-header-custom">
                        <h5 class="mb-0">
                            <i class="bi bi-images me-2"></i>
                            Imagens do Prontuário
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${#lists.isEmpty(imagens)}" class="text-center py-4">
                            <i class="bi bi-image fs-1 text-muted"></i>
                            <p class="text-muted mt-2">Nenhuma imagem adicionada ainda</p>
                        </div>
                        
                        <div class="row" th:if="${!#lists.isEmpty(imagens)}">
                            <div class="col-md-3 mb-3" th:each="imagem : ${imagens}">
                                <div class="card h-100">
                                    <img th:src="${imagem.dataUrl}" 
                                         th:alt="${imagem.nomeArquivo}"
                                         class="card-img-top imagem-thumb"
                                         style="height: 200px; object-fit: cover;"
                                         data-bs-toggle="modal" 
                                         data-bs-target="#imagemModal"
                                         th:data-imagem="${imagem.dataUrl}"
                                         th:data-nome="${imagem.nomeArquivo}"
                                         th:data-descricao="${imagem.descricao}">
                                    
                                    <div class="card-body p-2">
                                        <h6 class="card-title mb-1" th:text="${imagem.tipoImagem}">Tipo</h6>
                                        <p class="card-text small mb-1" th:text="${imagem.nomeArquivo}">arquivo.jpg</p>
                                        <p class="card-text small text-muted mb-1" th:text="${imagem.tamanhoFormatado}">1.2 MB</p>
                                        <p class="card-text small text-muted" th:text="${#temporals.format(imagem.dataUpload, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</p>
                                    </div>
                                    
                                    <div class="card-footer p-2">
                                        <div class="btn-group w-100" role="group">
                                            <a th:href="@{/prontuarios/imagem/{id}(id=${imagem.id})}" 
                                               class="btn btn-sm btn-outline-primary"
                                               title="Visualizar em tela cheia">
                                                <i class="bi bi-arrows-fullscreen"></i>
                                            </a>
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    th:onclick="|removerImagem(${imagem.id})|"
                                                    title="Remover imagem">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba: Tratamentos -->
            <div class="tab-pane fade" id="tratamentos-pane" role="tabpanel">
                <!-- Adicionar Tratamento -->
                <div class="card card-prontuario">
                    <div class="card-header card-header-custom">
                        <h5 class="mb-0">
                            <i class="bi bi-plus-circle me-2"></i>
                            Registrar Novo Tratamento
                        </h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/prontuarios/{id}/tratamento(id=${prontuario.id})}" method="post">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Procedimento *</label>
                                        <input type="text" class="form-control" name="procedimento" 
                                               placeholder="Ex: Restauração, Limpeza, Canal..." required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Dente</label>
                                        <input type="text" class="form-control" name="dente" 
                                               placeholder="Ex: 16, 21, 46...">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Valor do Procedimento</label>
                                        <div class="input-group">
                                            <span class="input-group-text">R$</span>
                                            <input type="number" class="form-control" name="valorProcedimento" 
                                                   step="0.01" min="0" placeholder="0,00">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Descrição</label>
                                        <textarea class="form-control" name="descricao" rows="3"
                                                placeholder="Descrição detalhada do procedimento..."></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Material Utilizado</label>
                                        <textarea class="form-control" name="materialUtilizado" rows="2"
                                                placeholder="Materiais utilizados no procedimento..."></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Observações</label>
                                <textarea class="form-control" name="observacoes" rows="2"
                                        placeholder="Observações adicionais..."></textarea>
                            </div>
                            
                            <div class="text-end">
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-check-circle me-2"></i>Registrar Tratamento
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Lista de Tratamentos -->
                <div class="card card-prontuario">
                    <div class="card-header card-header-custom">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul me-2"></i>
                            Histórico de Tratamentos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${#lists.isEmpty(tratamentos)}" class="text-center py-4">
                            <i class="bi bi-clipboard-data fs-1 text-muted"></i>
                            <p class="text-muted mt-2">Nenhum tratamento registrado ainda</p>
                        </div>
                        
                        <div th:if="${!#lists.isEmpty(tratamentos)}">
                            <div class="tratamento-item mb-3 pb-3 border-bottom" th:each="tratamento : ${tratamentos}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">
                                            <span th:text="${tratamento.procedimento}">Procedimento</span>
                                            <span th:if="${tratamento.dente}" class="text-muted">
                                                - Dente <span th:text="${tratamento.dente}">16</span>
                                            </span>
                                        </h6>
                                        
                                        <p class="mb-1 text-muted small">
                                            <i class="bi bi-calendar me-1"></i>
                                            <span th:text="${#temporals.format(tratamento.dataTratamento, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</span>
                                            
                                            <span th:if="${tratamento.valorProcedimento}" class="ms-3">
                                                <i class="bi bi-currency-dollar me-1"></i>
                                                R$ <span th:text="${#numbers.formatDecimal(tratamento.valorProcedimento, 1, 2)}">0,00</span>
                                            </span>
                                        </p>
                                        
                                        <p th:if="${tratamento.descricao}" class="mb-1" th:text="${tratamento.descricao}">
                                            Descrição do tratamento
                                        </p>
                                        
                                        <p th:if="${tratamento.materialUtilizado}" class="mb-1 text-muted small">
                                            <strong>Material:</strong> <span th:text="${tratamento.materialUtilizado}">Material</span>
                                        </p>
                                        
                                        <p th:if="${tratamento.observacoes}" class="mb-0 text-muted small">
                                            <strong>Obs:</strong> <span th:text="${tratamento.observacoes}">Observações</span>
                                        </p>
                                    </div>
                                    
                                    <div class="text-end">
                                        <span class="badge status-badge"
                                              th:classappend="${tratamento.status.name() == 'CONCLUIDO'} ? 'bg-success' : 
                                                              (${tratamento.status.name() == 'EM_ANDAMENTO'} ? 'bg-primary' : 
                                                              (${tratamento.status.name() == 'PLANEJADO'} ? 'bg-warning' : 'bg-secondary'))"
                                              th:text="${tratamento.status.descricao}">Status</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Visualizar Imagem -->
    <div class="modal fade" id="imagemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imagemModalTitle">Visualizar Imagem</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" 
                            aria-label="Fechar modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="imagemModalImg" src="" alt="" class="img-fluid rounded">
                    <p id="imagemModalDesc" class="mt-2 text-muted"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Upload de arquivo
        document.getElementById('uploadArea').addEventListener('click', function() {
            document.getElementById('arquivo').click();
        });
        
        document.getElementById('arquivo').addEventListener('change', function() {
            const fileName = this.files[0]?.name;
            if (fileName) {
                document.querySelector('.upload-area p').textContent = 'Arquivo selecionado: ' + fileName;
            }
        });
        
        // Drag and drop
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('arquivo').files = files;
                document.querySelector('.upload-area p').textContent = 'Arquivo selecionado: ' + files[0].name;
            }
        });
        
        // Modal de imagem
        document.addEventListener('DOMContentLoaded', function() {
            const imagemModal = document.getElementById('imagemModal');
            const modalImg = document.getElementById('imagemModalImg');
            const modalTitle = document.getElementById('imagemModalTitle');
            const modalDesc = document.getElementById('imagemModalDesc');
            
            document.querySelectorAll('.imagem-thumb').forEach(img => {
                img.addEventListener('click', function() {
                    modalImg.src = this.dataset.imagem;
                    modalImg.alt = this.dataset.nome;
                    modalTitle.textContent = this.dataset.nome;
                    modalDesc.textContent = this.dataset.descricao || 'Sem descrição';
                });
            });
        });
        
        // Remover imagem
        function removerImagem(imagemId) {
            if (confirm('Tem certeza que deseja remover esta imagem?')) {
                fetch('/prontuarios/imagem/' + imagemId, {
                    method: 'DELETE',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'sucesso') {
                        location.reload();
                    } else {
                        alert('Erro ao remover imagem: ' + data.mensagem);
                    }
                })
                .catch(error => {
                    alert('Erro ao remover imagem');
                });
            }
        }
    </script>
</body>
</html>
